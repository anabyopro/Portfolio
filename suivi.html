<!DOCTYPE html>
<html lang="fr" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Suivi de Demande - AnaByo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .status-dot {
        width: 1rem;
        height: 1rem;
        border-radius: 9999px;
      }
      .status-line {
        width: 2px;
        flex-grow: 1;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200">
    <!-- Header simple -->
    <header class="bg-black/50 shadow-lg">
      <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
          <a href="./index.html" class="flex-shrink-0 flex items-center">
            <img
              class="h-16 w-auto"
              src="./assets/logo_anabyo.png"
              alt="Logo AnaByo"
            />
            <span class="ml-3 text-3xl font-bold text-white"
              ><span class="text-sky-400">Ana</span
              ><span class="text-lime-400">Byo</span></span
            >
          </a>
          <a
            href="./index.html#contact-devis"
            class="px-5 py-2 bg-sky-600 text-white rounded-lg font-medium hover:bg-sky-700 transition-colors"
          >
            Nouvelle Demande
          </a>
        </div>
      </nav>
    </header>

    <!-- Section principale -->
    <main class="py-16 sm:py-24">
      <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Formulaire de recherche -->
        <div id="search-section" class="text-center">
          <h1 class="text-4xl font-extrabold text-white">
            Suivi de votre demande
          </h1>
          <p class="mt-4 text-lg text-gray-300">
            Entrez l'identifiant de suivi reçu par e-mail pour consulter l'état
            d'avancement de votre projet.
          </p>

          <form
            id="tracking-form"
            class="mt-10 flex flex-col sm:flex-row gap-3"
          >
            <input
              type="text"
              id="tracking-id-input"
              name="trackingId"
              class="flex-grow py-3 px-4 block w-full shadow-sm text-gray-900 bg-gray-100 rounded-md placeholder-gray-500 focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="Ex: ANA-A1B2C3D4"
              required
            />
            <button
              type="submit"
              class="inline-flex items-center justify-center px-8 py-3 bg-indigo-600 text-white rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition-colors text-lg"
            >
              Suivre
            </button>
          </form>
        </div>

        <!-- Section des résultats (cachée par défaut) -->
        <div id="result-section" class="mt-16 hidden">
          <!-- Le contenu sera injecté ici par JavaScript -->
        </div>
      </div>
    </main>

    <!-- Footer simple -->
    <footer class="bg-gray-900 text-gray-400 py-10 border-t border-gray-800">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <p class="text-sm font-medium text-gray-300">
          &copy; 2025 Bourachot Tom - AnaByo
        </p>
      </div>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const trackingForm = document.getElementById("tracking-form");
        const trackingInput = document.getElementById("tracking-id-input");
        const resultSection = document.getElementById("result-section");

        trackingForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const trackingId = trackingInput.value.trim().toUpperCase();
          if (!trackingId) return;

          resultSection.innerHTML = `<p class="text-center text-lg">Recherche en cours...</p>`;
          resultSection.classList.remove("hidden");

          try {
            const response = await fetch(
              `/.netlify/functions/get-status?id=${trackingId}`
            );

            if (response.status === 404) {
              resultSection.innerHTML = `<p class="text-center text-red-400 text-lg">Aucune demande trouvée avec l'identifiant <strong>${trackingId}</strong>. Veuillez vérifier votre saisie.</p>`;
              return;
            }

            if (!response.ok) {
              throw new Error(
                "Une erreur est survenue lors de la communication avec le serveur."
              );
            }

            const data = await response.json();
            displayStatus(data);
          } catch (error) {
            console.error("Erreur:", error);
            resultSection.innerHTML = `<p class="text-center text-red-400 text-lg">Une erreur technique est survenue. Veuillez réessayer plus tard.</p>`;
          }
        });

        function displayStatus(data) {
          const statuses = ["Reçue", "En cours", "Terminée"];
          const currentStatusIndex = statuses.indexOf(data.statut);
          const date = new Date(data.date_creation).toLocaleDateString(
            "fr-FR",
            { day: "numeric", month: "long", year: "numeric" }
          );

          let timelineHtml = `
                    <h2 class="text-2xl font-bold text-center text-white">Demande de ${data.nom_client}</h2>
                    <p class="text-center text-gray-400 mb-8">Reçue le ${date}</p>
                    <div class="space-y-4">
                `;

          statuses.forEach((status, index) => {
            const isActive = index <= currentStatusIndex;
            const isCurrent = index === currentStatusIndex;
            const color = isActive ? "bg-green-500" : "bg-gray-600";
            const textColor = isCurrent
              ? "text-white font-bold"
              : "text-gray-400";

            timelineHtml += `
                        <div class="flex items-center">
                            <div class="status-dot ${color}"></div>
                            <p class="ml-4 text-lg ${textColor}">${status}</p>
                        </div>
                    `;
          });

          timelineHtml += `</div>`;

          if (data.statut === "Refusée") {
            timelineHtml = `<h2 class="text-2xl font-bold text-center text-white">Demande de ${data.nom_client}</h2><p class="text-center text-yellow-400 text-lg mt-4">Cette demande n'a pas été prise en charge.</p>`;
          }

          resultSection.innerHTML = timelineHtml;
        }
      });
    </script>
  </body>
</html>
